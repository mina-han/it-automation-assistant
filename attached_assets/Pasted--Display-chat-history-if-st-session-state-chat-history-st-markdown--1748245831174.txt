# Display chat history
    if st.session_state.chat_history:
        st.markdown("### ğŸ’¬ ëŒ€í™” ë‚´ì—­")
        for i, (user_msg, bot_msg) in enumerate(st.session_state.chat_history):
            with st.container():
                st.markdown(f"**ğŸ‘¤ ì‚¬ìš©ì:** {user_msg}")
                
                # QnA ë²„íŠ¼ì´ í¬í•¨ëœ ì‘ë‹µ ì²˜ë¦¬
                if "|QNA_BUTTONS" in bot_msg:
                    base_message = bot_msg.split("|QNA_BUTTONS")[0]
                    
                    # ë©”ì‹œì§€ì—ì„œ ê´€ë ¨ ìœ ì‚¬ ì´ìŠˆë“¤ ë¶€ë¶„ê³¼ ë‚˜ë¨¸ì§€ ë¶„ë¦¬
                    if "ğŸ“š **ê´€ë ¨ ìœ ì‚¬ ì´ìŠˆë“¤:**" in base_message:
                        parts = base_message.split("ğŸ“š **ê´€ë ¨ ìœ ì‚¬ ì´ìŠˆë“¤:**")
                        main_message = parts[0]
                        related_issues_section = "ğŸ“š **ê´€ë ¨ ìœ ì‚¬ ì´ìŠˆë“¤:**" + parts[1]
                        
                        st.markdown(f"**ğŸ¤– ë¬¼ì–´ë³´SHOO:** {main_message}")
                        st.markdown(related_issues_section)
                        
                        # ê´€ë ¨ ìœ ì‚¬ ì´ìŠˆë“¤ ë°”ë¡œ ë°‘ì— QnA ë“±ë¡ ë²„íŠ¼ë“¤ í‘œì‹œ
                        col1, col2 = st.columns([1, 1])
                        with col1:
                            if st.button("âœ… ì˜ˆ", key=f"qna_yes_{i}", type="primary", use_container_width=True):
                                # QnA ê²Œì‹œíŒì— ì§ˆë¬¸ ë“±ë¡ (ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© ID 5 ì‚¬ìš©)
                                question_id = st.session_state.db_manager.add_qna_question_from_chat(
                                    user_msg, 5  # ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© ID
                                )
                                if question_id:
                                    # ì œëª© ìƒì„± (ì• 20ì)
                                    title = user_msg[:20] + ('...' if len(user_msg) > 20 else '')
                                    st.success(f"âœ… ì§ˆë¬¸ì´ QnA ê²Œì‹œíŒì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                    st.info(f"ğŸ“ ì œëª©: {title}")
                                    st.info(f"ğŸ“Š ì¹´í…Œê³ ë¦¬: ë°ì´í„°ë² ì´ìŠ¤ | ìœ í˜•: issue | ìƒíƒœ: ëŒ€ê¸°ì¤‘")
                                    st.info("ğŸ‰ ì§ˆë¬¸ ë“±ë¡ìœ¼ë¡œ 2ì ì˜ ê²½í—˜ì¹˜ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!")
                                    # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                    st.session_state.chat_history[i] = (user_msg, base_message)
                                else:
                                    st.error("âŒ ì§ˆë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                                st.rerun()
                        with col2:
                            if st.button("âŒ ì•„ë‹ˆì˜¤", key=f"qna_no_{i}", use_container_width=True):
                                # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                st.session_state.chat_history[i] = (user_msg, base_message)
                                st.rerun()
                    else:
                        st.markdown(f"**ğŸ¤– ë¬¼ì–´ë³´SHOO:** {base_message}")
                        
                        # QnA ë“±ë¡ ë²„íŠ¼ë“¤ í‘œì‹œ
                        col1, col2 = st.columns([1, 1])
                        with col1:
                            if st.button("âœ… ì˜ˆ", key=f"qna_yes_{i}", type="primary", use_container_width=True):
                                # QnA ê²Œì‹œíŒì— ì§ˆë¬¸ ë“±ë¡ (ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© ID 5 ì‚¬ìš©)
                                question_id = st.session_state.db_manager.add_qna_question_from_chat(
                                    user_msg, 5  # ì„ì‹œ í…ŒìŠ¤íŠ¸ìš© ID
                                )
                                if question_id:
                                    # ì œëª© ìƒì„± (ì• 20ì)
                                    title = user_msg[:20] + ('...' if len(user_msg) > 20 else '')
                                    st.success(f"âœ… ì§ˆë¬¸ì´ QnA ê²Œì‹œíŒì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                    st.info(f"ğŸ“ ì œëª©: {title}")
                                    st.info(f"ğŸ“Š ì¹´í…Œê³ ë¦¬: ë°ì´í„°ë² ì´ìŠ¤ | ìœ í˜•: issue | ìƒíƒœ: ëŒ€ê¸°ì¤‘")
                                    st.info("ğŸ‰ ì§ˆë¬¸ ë“±ë¡ìœ¼ë¡œ 2ì ì˜ ê²½í—˜ì¹˜ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!")
                                    # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                    st.session_state.chat_history[i] = (user_msg, base_message)
                                else:
                                    st.error("âŒ ì§ˆë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                                st.rerun()
                        with col2:
                            if st.button("âŒ ì•„ë‹ˆì˜¤", key=f"qna_no_{i}", use_container_width=True):
                                # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                st.session_state.chat_history[i] = (user_msg, base_message)
                                st.rerun()
                
                # ì§€ì‹ ë“±ë¡ ë²„íŠ¼ì´ í¬í•¨ëœ ì‘ë‹µ ì²˜ë¦¬
                elif "|KNOWLEDGE_BUTTONS" in bot_msg:
                    base_message = bot_msg.split("|KNOWLEDGE_BUTTONS")[0]
                    st.markdown(f"**ğŸ¤– ë¬¼ì–´ë³´SHOO:** {base_message}")
                    
                    # ì§€ì‹ ë“±ë¡ ë²„íŠ¼ë“¤ í‘œì‹œ
                    col1, col2 = st.columns([1, 1])
                    with col1:
                        if st.button("âœ… ì˜ˆ", key=f"knowledge_yes_{i}", use_container_width=True):
                            # ê¸°ì¡´ ì§€ì‹ ë“±ë¡ ë¡œì§
                            user = st.session_state.get('current_user', None)
                            if user and isinstance(user, (list, tuple)) and len(user) > 0:
                                user_id = user[0]
                                question_title = f"{user_msg[:50]}{'...' if len(user_msg) > 50 else ''}"
                                question_type = "manual" if "ë§¤ë‰´ì–¼" in base_message else "issue"
                                question_id = st.session_state.db_manager.add_qna_question(
                                    question_title, user_msg, "ê¸°íƒ€", question_type, user_id
                                )
                                if question_id:
                                    st.success("âœ… QnA ê²Œì‹œíŒì— ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (+2 ê²½í—˜ì¹˜)")
                                    st.info("ğŸ¯ QnA ê²Œì‹œíŒì—ì„œ ë“±ë¡ëœ ì§ˆë¬¸ì„ í™•ì¸í•˜ì„¸ìš”!")
                                    st.session_state.current_page = "â“ QnA ê²Œì‹œíŒ"
                                    # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                    st.session_state.chat_history[i] = (user_msg, base_message)
                                    st.rerun()
                                else:
                                    st.error("âŒ ì§ˆë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                            else:
                                st.error("âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
                    with col2:
                        if st.button("âŒ ì•„ë‹ˆì˜¤", key=f"knowledge_no_{i}", use_container_width=True):
                            st.info("ğŸ’­ ë‚˜ì¤‘ì— í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  QnA ê²Œì‹œíŒì´ë‚˜ ì—…ë¬´ ì§€ì‹ ë“±ë¡ì„ ì´ìš©í•´ì£¼ì„¸ìš”!")
                            # ë²„íŠ¼ ì œê±°ë¥¼ ìœ„í•´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                            st.session_state.chat_history[i] = (user_msg, base_message)
                            st.rerun()
                
                # ì¼ë°˜ ì‘ë‹µ
                else:
                    st.markdown(f"**ğŸ¤– ë¬¼ì–´ë³´SHOO:** {bot_msg}")
                
                if i < len(st.session_state.chat_history) - 1:
                    st.markdown("---")
        st.markdown("---")
    else:
        st.info("ğŸ’¡ ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œ